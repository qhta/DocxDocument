namespace ModelGenApp.ViewModels;
public class PropInfoViewModel : ViewModel<PropInfo>, IAcceptable
{
  public PropInfoViewModel(PhaseResultsViewModel phase, ClassInfoViewModel? owner, PropInfo propInfo, TNS typeNameSelector) : base(propInfo)
  {
    Owner = owner;
    TypeNameSelector = typeNameSelector;
    Phase = phase;
  }

  [DataGridColumn(IsAutoGenerated = false)]
  public ClassInfoViewModel? Owner { get; private set; }

  [DataGridColumn(IsAutoGenerated = false)]
  public TNS TypeNameSelector { get; private set; }

  [DataGridColumn(IsAutoGenerated = false)]
  public PhaseResultsViewModel Phase { get; private set; }

  public bool IsAccepted => Model.IsAcceptedAfter(Phase.PhaseNum);

  [DataGridColumn(
    HeaderResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.Acceptance),
    HeaderTooltipResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.AcceptanceTooltip)
    )]
  public Acceptance Acceptance
  {
    get
    {
      Acceptance result = 0;
      if (Model.IsAcceptedAfter(Phase.PhaseNum))
        result |= Acceptance.accepted;
      if (Model.IsRejectedAfter(Phase.PhaseNum))
        result |= Acceptance.rejected;
      return result;
    }
  }

  public bool ShowFullTypeName
  {
    get => _ShowFullTypeName;
    set
    {
      if (_ShowFullTypeName != value)
      {
        _ShowFullTypeName = value;
        NotifyPropertyChanged(nameof(ShowFullTypeName));
        if (DeclaringType != null)
          _DeclaringType = null;
        NotifyPropertyChanged(nameof(DeclaringType));
        if (ValueType != null)
          _ValueType = null;
        NotifyPropertyChanged(nameof(ValueType));
      }
    }
  }
  private bool _ShowFullTypeName;

  //public string? DeclaringTypeName
  //{
  //  get
  //  {
  //    if (TypeNameSelector.Target)
  //      return TargetTypeName;
  //    else
  //      return DeclaringType.FullName;
  //  }
  //}

  [DataGridColumn(
    HeaderResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.DeclaringType),
    HeaderTooltipResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.DeclaringTypeTooltip),
    DataTemplateResourceKey = "TypeInfoLinkTemplate",
    SortMemberPath = "DeclaringType.FullName",
    ClipboardContentPath = "DeclaringType.FullName")]
  public TypeInfoViewModel? DeclaringType
  {
    get
    {
      if (_DeclaringType == null)
      {
        if (Model.DeclaringType != null)
          _DeclaringType = TypeInfoViewModel.Create(Phase, Model.DeclaringType, TypeNameSelector);
      }
      return _DeclaringType;
    }
    //set
    //{
    //  _DeclaringType = value;
    //}
  }
  private TypeInfoViewModel? _DeclaringType;

  [DataGridColumn(
    HeaderResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.PropertyName),
    HeaderTooltipResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.PropertyNameTooltip)
    )]
  public string Name
  {
    get
    {
      if (TypeNameSelector.NTS == NTS.Target)
        return Model.GetTargetName();
      return Model.Name;
    }
  }

  [DataGridColumn(
    HeaderResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.ValueType),
    HeaderTooltipResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.ValueTypeTooltip),
    DataTemplateResourceKey = "TypeInfoLinkTemplate",
    SortMemberPath = "ValueType.Name",
    ClipboardContentPath = "ValueType.Name")]
  public TypeInfoViewModel? ValueType
  {
    get
    {
      var propType = Model.PropertyType;
      if (TypeNameSelector.NTS == NTS.Target)
        propType = Model.TargetType ?? propType.TargetType;
      if (propType != null && _ValueType == null)
      {
        if (propType.TypeKind == TypeKind.@enum)
          _ValueType = new EnumTypeInfoViewModel(Phase, propType, TypeNameSelector);
        else
        if (propType.TypeKind == TypeKind.type)
          _ValueType = TypeInfoViewModel.Create(Phase, propType, TypeNameSelector);
        else
          _ValueType = new ClassInfoViewModel(Phase, propType, TypeNameSelector);
      }
      return _ValueType;
    }
  }
  private TypeInfoViewModel? _ValueType;

  [DataGridColumn(
    Header = "",
    HiddenHeaderResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.Problem),
    DataTemplateResourceKey = "ErrorMarkButtonTemplate"
  )]
  public string? ValidationError
  {
    get
    {
      var errCode = Model.Errors?.FirstOrDefault(item => item.Phase == Phase.PhaseNum)?.Code;
      if (errCode != null)
      {
        var errCodeName = errCode?.ToString();
        if (errCodeName != null)
        {
          var msg = CommonStrings.ResourceManager.GetString(errCodeName);
          if (String.IsNullOrEmpty(msg))
            msg = errCodeName.DeCamelCase();
          return msg;
        }
      }
      return null;
    }
  }

  [DataGridColumn(
    HeaderResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.Description),
    HeaderTooltipResourceKey = "ModelGenApp.CommonStrings." + nameof(CommonStrings.DescriptionTooltip)
    )]
  public string? Description => Model.Description;

  #region ShowErrorCommand

  public Command? ShowErrorCommand => null;

  //protected virtual bool ShowErrorCanExecute()
  //{
  //  return ValidationError != null;
  //}

  //protected virtual void ShowErrorExecute()
  //{
  //  Phase.ShowErrorFor(this);
  //}
  #endregion
}

